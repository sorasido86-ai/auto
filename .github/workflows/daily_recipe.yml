name: Daily Recipe → WordPress (AM/PM)

on:
  # ✅ (1) 시간만 바꾸면 됨 (GitHub cron은 UTC 기준)
  # - 09:23 KST = 00:23 UTC
  # - 18:05 KST = 09:05 UTC
  schedule:
    - cron: "23 0 * * *"   # AM (KST 09:23)
    - cron: "5 9 * * *"   # PM (KST 18:05)

  workflow_dispatch:
    inputs:
      slot:
        description: "Run slot (am/pm/day)"
        required: true
        default: "am"
        type: choice
        options: [am, pm, day]
      force_new:
        description: "Force new recipe even if already posted today (0/1)"
        required: false
        default: "0"

concurrency:
  group: daily-recipe-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ✅ openai 누락 방지: 무조건 설치
      - name: Install deps (always)
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai requests
          # requirements.txt가 있으면 거기에 있는 것들도 추가 설치
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ✅ 슬롯 자동 판별(스케줄 실행일 때만)
      - name: Resolve RUN_SLOT
        id: slot
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RUN_SLOT=${{ inputs.slot }}" >> $GITHUB_OUTPUT
            echo "FORCE_NEW=${{ inputs.force_new }}" >> $GITHUB_OUTPUT
          else
            HOUR_UTC=$(date -u +%H)
            if [ "$HOUR_UTC" = "00" ]; then
              echo "RUN_SLOT=am" >> $GITHUB_OUTPUT
            elif [ "$HOUR_UTC" = "09" ]; then
              echo "RUN_SLOT=pm" >> $GITHUB_OUTPUT
            else
              echo "RUN_SLOT=day" >> $GITHUB_OUTPUT
            fi
            echo "FORCE_NEW=0" >> $GITHUB_OUTPUT
          fi

      - name: Restore sqlite cache
        uses: actions/cache@v4
        with:
          path: data
          key: daily-recipe-sqlite-${{ github.run_id }}
          restore-keys: |
            daily-recipe-sqlite-

      - name: Run bot
        env:
          # ✅ 필수 Secrets (여기 4개는 GitHub Secrets에 등록되어 있어야 함)
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASS: ${{ secrets.WP_APP_PASS }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # ✅ (2) 카테고리 번호 바꾸려면 여기만 변경
          WP_CATEGORY_IDS: "7"
          WP_STATUS: "publish"
          WP_TAG_IDS: ""

          SQLITE_PATH: "data/daily_recipe.sqlite3"

          RUN_SLOT: ${{ steps.slot.outputs.RUN_SLOT }}
          FORCE_NEW: ${{ steps.slot.outputs.FORCE_NEW }}

          STRICT_KOREAN: "1"
          OPENAI_MODEL: "gpt-5.2"
          OPENAI_MAX_RETRIES: "3"
          AVOID_REPEAT_DAYS: "90"
          MAX_TRIES: "20"

          UPLOAD_THUMB: "1"
          SET_FEATURED: "1"
          EMBED_IMAGE_IN_BODY: "1"

          FREE_TRANSLATE_URL: "https://libretranslate.de/translate"
          FREE_TRANSLATE_SOURCE: "en"
          FREE_TRANSLATE_TARGET: "ko"
          # FREE_TRANSLATE_API_KEY: ${{ secrets.FREE_TRANSLATE_API_KEY }}  # 필요할 때만

          DEBUG: "0"
          DRY_RUN: "0"

        run: |
          mkdir -p data
          echo "[RUN] slot=${RUN_SLOT} force_new=${FORCE_NEW}"
          # ✅ (3) 파이썬 파일명이 다르면 여기만 바꾸면 됨
          python daily_recipe_to_wp.py
