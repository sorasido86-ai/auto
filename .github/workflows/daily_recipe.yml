name: Daily Recipe to WP

on:
  schedule:
    - cron: "5 0 * * *"   # 09:05 KST
    - cron: "5 9 * * *"   # 18:05 KST
  workflow_dispatch:
    inputs:
      run_slot:
        description: "day / am / pm"
        required: false
        default: "day"

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Decide RUN_SLOT
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            if [ "${{ github.event.schedule }}" = "5 0 * * *" ]; then
              echo "RUN_SLOT=am" >> $GITHUB_ENV
            else
              echo "RUN_SLOT=pm" >> $GITHUB_ENV
            fi
          else
            echo "RUN_SLOT=${{ github.event.inputs.run_slot }}" >> $GITHUB_ENV
          fi

      - name: Run
        env:
          WP_BASE_URL: ${{ secrets.WP_BASE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASS: ${{ secrets.WP_APP_PASS }}

          # ✅ 카테고리 7번
          WP_CATEGORY_IDS: "7"

          # 한글 블로거톤(필수: OPENAI_API_KEY)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: "gpt-5-mini"
          KOREANIZE: "1"
          BLOG_TONE: "1"

          SQLITE_PATH: "data/daily_recipe.sqlite3"
          AVOID_REPEAT_DAYS: "90"
          MAX_TRIES: "20"

          UPLOAD_THUMB: "1"
          SET_FEATURED: "1"
          EMBED_IMAGE_IN_BODY: "1"

          WP_STATUS: "publish"
          DRY_RUN: "0"
          DEBUG: "0"
        run: |
          python daily_recipe_to_wp.py
